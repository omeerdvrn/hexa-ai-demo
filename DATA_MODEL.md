# Firestore Data Model

This document outlines the complete data structure for the logo generation application's Firestore database.

## Collections Overview

The application uses two main collections:
- `jobs` - Tracks logo generation requests and their processing status
- `logos` - Stores completed logo metadata and references

## Collection: `jobs`

**Purpose:** Manages logo generation job lifecycle and real-time status updates.

### Document Structure

```javascript
{
  id: string,              // Auto-generated document ID
  userId: string,          // Reference to authenticated user
  type: string,            // Job type enum ("logo")
  status: string,          // Current processing status
  prompt: string,          // User's text prompt for generation
  style: number,           // Logo style index (0-3)
  seen: boolean,           // Whether user has viewed completed job
  createdAt: Timestamp,    // Server-side creation timestamp
  updatedAt: Timestamp,    // Server-side last update timestamp
  resultUrl: string|null,  // Generated image URL (when completed)
  error: string|null       // Error message (when failed)
}
```

### Field Details

| Field | Type | Client Writable | Server Writable | Description |
|-------|------|----------------|-----------------|-------------|
| `id` | `string` | L |  | Auto-generated by Firestore |
| `userId` | `string` |  |  | Set by client on creation |
| `type` | `string` |  | L | Set to "logo" on creation |
| `status` | `string` | L |  | Managed by Cloud Functions |
| `prompt` | `string` |  | L | User input, immutable after creation |
| `style` | `number` |  | L | User selection, immutable after creation |
| `seen` | `boolean` |  | L | Updated by client when viewing result |
| `createdAt` | `Timestamp` | L |  | Set by server on creation |
| `updatedAt` | `Timestamp` | L |  | Updated by server on status changes |
| `resultUrl` | `string\|null` | L |  | Set by Cloud Function when completed |
| `error` | `string\|null` | L |  | Set by Cloud Function on failure |

### Status Values

```javascript
const JobStatus = {
  IDLE: "idle",           // Initial state (not used in database)
  PROCESSING: "processing", // Job is being processed
  COMPLETED: "completed",   // Successfully generated
  FAILED: "failed"          // Generation failed
}
```

## Collection: `logos`

**Purpose:** Stores metadata for successfully generated logos with permanent references.

### Document Structure

```javascript
{
  id: string,              // Auto-generated document ID
  jobId: string,           // Reference to originating job
  userId: string,          // Reference to authenticated user
  prompt: string,          // Original text prompt
  style: number,           // Logo style used
  storageUrl: string,      // Firebase Storage URL for logo image
  createdAt: Timestamp,    // Server-side creation timestamp
  updatedAt: Timestamp     // Server-side last update timestamp
}
```

### Field Details

| Field | Type | Client Writable | Server Writable | Description |
|-------|------|----------------|-----------------|-------------|
| `id` | `string` | L |  | Auto-generated by Firestore |
| `jobId` | `string` | L |  | Reference to completed job |
| `userId` | `string` | L |  | Copied from job document |
| `prompt` | `string` | L |  | Copied from job document |
| `style` | `number` | L |  | Copied from job document |
| `storageUrl` | `string` | L |  | Firebase Storage URL |
| `createdAt` | `Timestamp` | L |  | Set when logo is saved |
| `updatedAt` | `Timestamp` | L |  | Updated on modifications |

## Query Patterns

### Get Latest Job for User

```javascript
// Query the most recent job for a user
const getLatestJob = async (userId) => {
  const q = query(
    collection(db, Collections.JOBS),
    where("userId", "==", userId),
    orderBy("createdAt", "desc"),
    limit(1)
  );
  
  const querySnapshot = await getDocs(q);
  if (!querySnapshot.empty) {
    const doc = querySnapshot.docs[0];
    return { id: doc.id, ...doc.data() };
  }
  return null;
};
```

### Get Logo by Job ID

```javascript
// Find logo associated with a specific job
const getLogoByJobId = async (jobId) => {
  const q = query(
    collection(db, Collections.LOGOS), 
    where("jobId", "==", jobId), 
    limit(1)
  );
  
  const querySnapshot = await getDocs(q);
  if (!querySnapshot.empty) {
    const doc = querySnapshot.docs[0];
    return { id: doc.id, ...doc.data() };
  }
  throw new Error("Logo not found for this job");
};
```

### Get User's Logos (Latest First)

```javascript
// Get user's logos ordered by creation date
const getUserLogos = async (userId, limitCount = 20) => {
  const q = query(
    collection(db, Collections.LOGOS),
    where("userId", "==", userId),
    orderBy("createdAt", "desc"),
    limit(limitCount)
  );
  
  const querySnapshot = await getDocs(q);
  const logos = [];
  querySnapshot.forEach((doc) => {
    logos.push({ id: doc.id, ...doc.data() });
  });
  return logos;
};
```

### Real-time Job Subscription

```javascript
// Subscribe to job status updates
const subscribeToJob = (jobId, callback) => {
  const jobRef = doc(db, Collections.JOBS, jobId);
  
  return onSnapshot(jobRef, (doc) => {
    if (doc.exists()) {
      callback({ id: doc.id, ...doc.data() });
    } else {
      callback(null);
    }
  }, (error) => {
    console.error("Error listening to job updates:", error);
    callback(null, error);
  });
};
```

## Data Flow

1. **Job Creation:** Client creates job document with user inputs
2. **Processing:** Cloud Function updates job status and processes generation
3. **Completion:** Cloud Function updates job with resultUrl and creates logo document
4. **Display:** Client fetches logo data using jobId for permanent reference

## Security Rules Considerations

- **Jobs Collection:** Users can read/write their own jobs, server can update status/results
- **Logos Collection:** Users can read their own logos, only server can write
- **Authentication:** All operations require valid Firebase Auth token
- **User Isolation:** All queries filtered by userId to ensure data privacy